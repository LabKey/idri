<style type="text/css">

    div.sample-preview {
        float: left;
        margin:  8px;
        border: 1px solid #d3d3d3;
    }

    div.sample-preview:hover {
        cursor: pointer;
    }

    div.x4-item-selected {
        background: #d3d3d3;
    }

    .sample-error {
        background: pink !important;
    }

</style>
<div id="test-render"></div>
<div id="hplc-upload-content"></div>
<div id="pipelineBrowser" class="extContainer"></div>
<script type="text/javascript">
    LABKEY.requiresExt4ClientAPI(true);
    LABKEY.requiresScript("FileUploadField.js");

    var visScripts = [
        'vis/lib/patches.js',
        'vis/lib/d3-2.0.4.js',
        'vis/lib/raphael-min-2.1.0.js',
        'vis/src/utils.js',
        'vis/src/geom.js',
        'vis/src/stat.js',
        'vis/src/position.js',
        'vis/src/scale.js',
        'vis/src/layer.js',
        'vis/src/plot.js'
    ];

    LABKEY.requiresScript(visScripts, true, null, this, true);

    var scripts = [
        'applet.js',
        'FileUploadField.js',
        'StatusBar.js',
        'fileBrowser.js',
        'Reorderer.js',
        'ToolbarDroppable.js',
        'ToolbarReorderer.js',
        'ActionsAdmin.js',
        'PipelineAction.js',
        'FileProperties.js',
        'FileContent.js'
    ];

    LABKEY.requiresScript(scripts);
    LABKEY.requiresScript('formulations/HPLCUploadPanel.js');
</script>
<script type="text/javascript">

    var initHPLCUPload = function()
    {
        var _fileBrowser, _fileSystem;

        Ext.onReady(function(){

            LABKEY.Pipeline.getPipelineContainer({
                success : function(data) {
                    if (data && data.containerPath)
                        createFileBrowser(data.webDavURL);
                    else
                    {
                        var html = "The data pipeline has not yet been configured for this folder.";
                        if (LABKEY.Security.currentUser.isAdmin)
                        {
                            html += " [<a href='";
                            html += Ext.util.Format.htmlEncode(LABKEY.ActionURL.buildURL("pipeline","setup"));
                            html += "'>Setup Pipeline</a>]";
                        }
                        Ext.get("pipelineBrowser").update(html);
                    }
                }
            });

        });

        var createFileBrowser = function(pipeURL)
        {
            _fileSystem = new LABKEY.FileSystem.WebdavFileSystem({
                baseUrl : pipeURL
            });

            _fileBrowser = new LABKEY.FilesWebPartPanel({
                fileSystem     : _fileSystem,
                statePrefix    : LABKEY.ActionURL.getContainer() + '#pipeline',
                helpEl         : null,
                showAddressBar : true,
                showDetails    : true,
                expandFileUpload : true,
                tbarItems : ['parentFolder', 'refresh', 'createDirectory', 'download', 'deletePath', 'upload',
                    {
                        id: 'hplc-import',
                        text: 'Import HPLC',
                        handler: onImport,
                        iconCls: 'iconCheck'
                    }],
                updateToolbarButtons : function() {
                    /* Overridden due to bad update timing */
                }
            });

            _fileBrowser.render("pipelineBrowser");
            _fileBrowser.start();
        }

        var onImport = function()
        {
            var folder = _fileBrowser.grid.getSelectionModel().getSelected();
            if (!folder) {
                folder = _fileBrowser.selectedRecord;
            }

            if (folder && folder.id != '/')
            {
                // Switching to Ext 4 -- must ensure it is ready
                Ext4.onReady(function(){

                    var panel = Ext4.create('LABKEY.assay.HPLCUploadPanel', {
                        targetFile : folder,
                        fileSystem : _fileSystem
                    });

                    var win = Ext4.create('Ext.window.Window', {
                        title : 'HPLC Assay Upload',
                        height: 600,
                        width : 800,
                        layout: 'fit',
                        items : [panel]
                    });
                    win.show();
                });
            }
            else
            {
                Ext.Msg.alert('Select Folder', 'Please select a folder containing HPLC run information.');
            }
        }
    }

    initHPLCUPload();

</script>