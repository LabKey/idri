<form id="SearchFormulation" method="get" action=""
      onsubmit="getRunIdIfUnique(document.getElementById('IdriSearchStr').value.toUpperCase(),document.getElementById('IdriPSAssayName').value); return false;">
    <table width="95%">
        <tr>
            <td>Formulation name contains:

                <input type="text" id="IdriSearchStr" name="nameContains" value="">
                <input type="hidden" id="IdriPSAssayName" name="assayName" value="Particle Size">

                <input type="submit" style="display: none;" id="IdriSearchSubmit"><a class="labkey-button" href="formulationSummary.html#"
                                                                                     onclick="getRunIdIfUnique(document.getElementById('IdriSearchStr').value.toUpperCase(),document.getElementById('IdriPSAssayName').value); return false;">
                    <span>Search</span></a>
            </td>
        </tr>
    </table>
</form>

<div id="stabilityBtnDiv">
<input type="button" id="stabilityBtn" style="display: none;"><a id="stabilityBtnHref" class="labkey-button" onclick="getStabilityReport(); return false;">
    <span>Stability Report</span></a>
</div>
        
<div id="printBtnDiv" style="display:none">
<input type="button" id="printBtn" style="display: none;"><a id="printBtnHref" class="labkey-button" onclick="printReport(); return false;">
    <span>Print Report</span></a>
</div>

<!-- Div to present errors on screen -->
<div id="errorDiv"></div>
        
<div id="reportDiv" style="display: none">
<p id="reportHeadline" style="text-align: center; font-size: large"><span style="text-decoration: underline;">Stable Emulsion Formulation</p>
    
<div id="reportDivTop" style="display: none"></div>

<p style="text-align: left;"><span style="text-decoration: underline;">Stability Test Results</span></p>
</div>
        
<div id='dataRegionDiv' align="left"></div>
<div id='dataRegionDiv2' align="left"></div>

<div id="reportDiv2" style="display: none">
<p style="text-align: left;"><span style="text-decoration: underline;">Sample Information</span></p>

<div id="reportDivMiddle" style="display: none"></div>
</div>
        
<table id="reportTable">
    <tr>
        <td>
            <div id="resultsDiv"></div>
        </td>
        <td>
            <div id="resultsDiv2"></div>
        </td>
        <td>
            <div id="concentrationDiv"></div>
        </td>
    </tr>
</table>
<script type="text/javascript">
    LABKEY.requiresScript("formulations/SearchFormulation.js");
</script>
<script type="text/javascript">

    var makePrintable, printReport, getStabilityReport;

    (function() {

        var onSuccessStat = function(data) {
            if (data.rowCount > 1)
                document.getElementById('errorDiv').innerHTML = "ERROR: The forumulation lookup did not work correctly.";

            var form = new LABKEY.ext.FormPanel({
                id: 'formulation-data-table',
                selectRowsResults: data,
                border: false,
                defaults: {
                    style: {
                        width: 72
                    },
                    disabledClass : null
                },
                items: [{
                    name: 'Name',
                    fieldLabel: 'Batch Number'
                },{
                    xtype: 'textfield',
                    name: 'DM',
                    fieldLabel: 'Manufacture Date'
                },{
                    name: 'Batch_size'
                }]
            });

            form.render("reportDivTop");
        };

        var onError = function(errorInfo, responseObj) {
            if(errorInfo && errorInfo.exception)
                alert("Failure: " + errorInfo.exception);
            else
                alert("Failure: " + responseObj.statusText);
        };

        /* Suppresses all elements which should not be shown in a printable format. */
        makePrintable = function()
        {
            document.getElementById("bodypanel").getElementsByTagName('tr')[0].style.display = "none";
            document.getElementById("headerpanel").style.display = "none";
            document.getElementById("navpanel").style.display = "none";
            document.getElementById("printBtnDiv").style.display = "none";
            document.getElementById("errorDiv").style.display = "none";

            /* Drop the administration bar menu if present. */
            var mb = document.getElementById("menubar");
            if(mb != null)
            {
                mb.style.display = "none";
            }
        };

        printReport = function()
        {
            makePrintable();

            /* Give the user a (2) second to see what has happened. */
            setTimeout("window.print()",2000);
        };

        getStabilityReport = function()
        {
            document.getElementById("stabilityBtnDiv").style.display = "none";
            document.getElementById("SearchFormulation").style.display = "none";
            document.getElementById("errorDiv").style.display = "none";

            document.getElementById("printBtnDiv").style.display = "inline";
            document.getElementById("reportDiv").style.display = "inline";
            document.getElementById("reportDivTop").style.display = "inline";
            document.getElementById("reportDiv2").style.display = "inline";
            document.getElementById("reportDivMiddle").style.display = "inline";
        };

        Ext.onReady(function() {
            // Check URL for 'nameContains' -- this is the users search parameter.
            var currentFormulation = LABKEY.ActionURL.getParameter('nameContains');
            if (null != currentFormulation)
            {
                // Build the grids. See SearchFormulation.js
                LABKEY.Query.selectRows({
                    schemaName: 'Samples',
                    queryName:  'StatReport',
                    success: onSuccessStat,
                    errorCallback: onError,
                    filterArray : [ LABKEY.Filter.create('Name', LABKEY.ActionURL.getParameter('nameContains'), LABKEY.Filter.Types.CONTAINS) ]
                });

                buildPSReports('5C', currentFormulation);
            }
            else
            {
                document.getElementById("stabilityBtnDiv").style.display = "none";
                document.getElementById('dataRegionDiv').innerHTML = "Use the search above to find a formulation lot."
                document.getElementById('resultsDiv').innerHTML = "";
            }
        });

    })();

</script>